<!DOCTYPE html>
<meta charset="utf-8">

<body>

  <div id='js-geojson-example'></div>

  <script src="js/d3.js"></script>
  <script src="js/common.js"></script>

  <link rel="stylesheet" href="style.css" />

  <script>
    d3.json("Data/blocks.json", function(json) {
      // create a first guess for the projection
      var center = d3.geo.centroid(json)

      var scale = 600000;
      var offset = [width / 2 + 5300, height / 2 + 8640];
      var projection = d3.geo.mercator()
        .scale(scale)
        .center(center)
        .translate(offset);

      // create the path
      var blockpath = d3.geo.path().projection(projection);


      blocks.append("path")
        .datum({
          type: "FeatureCollection",
          features: json.features
        })
        .attr("json", d3.geo.path())
        .attr("d", blockpath)
        .attr("class", "blox");


      // load the car data

      d3.json("Data/car.json", function(carjson) {

        var cardata = randomize(carjson);

        var selection = car.selectAll('path')
          .data(cardata.features)
          .enter()
          .append('svg:circle')
          .attr("transform", function(d) {
            return "translate(" + projection(d.geometry.coordinates) + ")";
          })

        startAnimation();
        repeat();

        function startAnimation() {
            selection.attr('r', 6)
              .transition()
              .duration(function(d) {
                  return 500
                //return Math.floor((Math.random() * 2000));
              })
              .attr("transform", function(d) {
                prj = projection(d.geometry.coordinates)
                prj[0] = prj[0] + d.properties.accuracy * 5
                prj[1] = prj[1] + d.properties.accuracy * 5
                return "translate(" + prj + ")";
              })
        }

        function repeat() {
          selection
            .transition()
            .duration(function(d) {
              return 1000
              //   return Math.floor((Math.random() * 4000))
            })
            .attr("transform", function(d) {
              prj = projection(d.geometry.coordinates)
              prj[0] = prj[0] - d.properties.accuracy * 5
              prj[1] = prj[1] - d.properties.accuracy * 5
              return "translate(" + prj + ")";
            })
            .transition()
            .duration(function(d) {
                return 1000
              //return Math.floor((Math.random() * 2000));
            })
            .attr("transform", function(d) {
              prj = projection(d.geometry.coordinates)
              prj[0] = prj[0] + d.properties.accuracy * 5
              prj[1] = prj[1] + d.properties.accuracy * 5
              return "translate(" + prj + ")";
            })
            .each("end", repeat);
        }


      });

      // add a rectangle to see the bound of the svg
      blocks.append("rect")
        .attr('width', width)
        .attr('height', height)
        .style('stroke', 'black')
        .style('fill', 'none');


    });
  </script>

  <body>
    <a href="index4.html" id="link">NEXT</a>
  </body>
